jQuery(document).ready(function(e){function i(){return window.FreemKitAdmin||{}}function t(e,t){return(i().strings||{})[e]||t}function n(e,i,t){e.text(t).attr("title",t).css("color",i?"#008a20":"#a60000")}function a(e){var i=e.find(".repeater-item-content").first();if(i.length&&!i.find(".freemkit-freemius-validate-wrap").length){var n=['<div class="freemkit-freemius-validate-wrap" style="display:flex;align-items:flex-start;gap:8px;margin:0 0 12px 0;padding:8px 10px;background:#f6f7f7;border:1px solid #dcdcde;border-radius:4px;">','<button type="button" class="button button-secondary button-small freemkit-test-freemius-keys">',t("validate_freemius_keys","Validate Keys"),"</button>",'<span class="freemkit-freemius-status" style="font-weight:500;font-size:12px;line-height:1.4;white-space:normal;word-break:break-word;"></span>',"</div>"].join("");i.prepend(n)}}function r(i){var t=e(i||document);t.is(".wz-repeater-item")&&t.find(':input[name$="[fields][id]"]').length&&t.find(':input[name$="[fields][public_key]"]').length&&t.find(':input[name$="[fields][secret_key]"]').length?a(t):t.find(".wz-repeater-item").each(function(){var i=e(this);i.find(':input[name$="[fields][id]"]').length&&i.find(':input[name$="[fields][public_key]"]').length&&i.find(':input[name$="[fields][secret_key]"]').length&&a(i)})}e(document).on("click",".test-kit-connection",function(a){a.preventDefault();var r=e(this),s=r.siblings(".kit-connection-status");r.prop("disabled",!0),s.html('<span class="spinner is-active" style="float:none;margin:0;"></span>'),e.ajax({url:i().ajax_url||ajaxurl,type:"POST",data:{action:"freemkit_test_kit_connection",nonce:i().nonce||""},success:function(e){e&&e.success?n(s,!0,e.data.message||t("kit_validation_success","Connection successful.")):n(s,!1,e&&e.data&&e.data.message||t("api_validation_error","Error validating API credentials."))},error:function(){n(s,!1,t("api_validation_error","Error validating API credentials."))},complete:function(){r.prop("disabled",!1)}})}),e(document).on("click",".freemkit-test-freemius-keys",function(a){a.preventDefault();var r=e(this),s=function(e){var i=e.closest(".wz-repeater-item");return{row:i,plugin_id:String(i.find(':input[name$="[fields][id]"]').val()||"").trim(),public_key:String(i.find(':input[name$="[fields][public_key]"]').val()||"").trim(),secret_key:String(i.find(':input[name$="[fields][secret_key]"]').val()||"").trim(),row_id:String(i.find(':input[name$="[row_id]"]').val()||"").trim()}}(r),d=s.row.find(".freemkit-freemius-status");s.plugin_id&&s.public_key&&s.secret_key?(r.prop("disabled",!0),d.html('<span class="spinner is-active" style="float:none;margin:0;"></span>'),e.ajax({url:i().ajax_url||ajaxurl,type:"POST",data:{action:"freemkit_validate_freemius_keys",nonce:i().nonce||"",plugin_id:s.plugin_id,public_key:s.public_key,secret_key:s.secret_key,row_id:s.row_id},success:function(e){e&&e.success?n(d,!0,e.data.message||t("freemius_validation_success","Freemius credentials are valid.")):n(d,!1,e&&e.data&&e.data.message||t("freemius_validation_error","Unable to validate Freemius credentials."))},error:function(){n(d,!1,t("freemius_validation_error","Unable to validate Freemius credentials."))},complete:function(){r.prop("disabled",!1)}})):n(d,!1,t("freemius_missing_fields","Product ID, public key, and secret key are required."))}),e(document).on("wz:repeater-item-added",function(e){r((e&&e.originalEvent&&e.originalEvent.detail?e.originalEvent.detail.container:null)||document)}),r(document)});